<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - Keuangan HUT RI ke-80</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        'brand-red': {
                            '50': '#fef2f2',
                            '100': '#fee2e2',
                            '200': '#fecaca',
                            '300': '#fca5a5',
                            '400': '#f87171',
                            '500': '#ef4444',
                            '600': '#dc2626',
                            '700': '#b91c1c',
                            '800': '#991b1b',
                            '900': '#7f1d1d',
                            '950': '#450a0a',
                        },
                    }
                }
            }
        }
    </script>
    <style>
        .pending-deletion { background-color: #fffbeb !important; }
        .pending-deletion td { text-decoration: line-through; color: #a1a1aa; }
        .loading-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(255, 255, 255, 0.8);
            display: flex; align-items: center; justify-content: center;
            z-index: 9999;
            backdrop-filter: blur(4px);
        }
        .spinner {
            border: 4px solid #e5e7eb;
            border-top: 4px solid #b91c1c;
            border-radius: 50%; width: 50px; height: 50px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .custom-modal { z-index: 10000; }
    </style>
</head>
<body class="bg-gray-50 font-sans antialiased">

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="loading-overlay hidden">
        <div class="spinner"></div>
    </div>

    <!-- Custom Confirmation Modal -->
    <div id="confirmation-modal" class="custom-modal fixed inset-0 bg-gray-900 bg-opacity-60 hidden items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-md p-6 text-center">
            <div class="mx-auto flex h-12 w-12 items-center justify-center rounded-full bg-red-100">
                <svg class="h-6 w-6 text-red-600" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126z" /></svg>
            </div>
            <h3 id="modal-title" class="text-lg font-semibold text-gray-900 mt-4">Konfirmasi Tindakan</h3>
            <p id="modal-message" class="text-sm text-gray-500 mt-2">Apakah Anda yakin ingin melanjutkan tindakan ini? Proses ini tidak dapat diurungkan.</p>
            <div class="mt-6 flex justify-center gap-4">
                <button id="modal-cancel-btn" class="w-full rounded-lg bg-gray-200 px-4 py-2.5 text-sm font-medium text-gray-800 hover:bg-gray-300">Batal</button>
                <button id="modal-confirm-btn" class="w-full rounded-lg bg-red-600 px-4 py-2.5 text-sm font-medium text-white hover:bg-red-700">Ya, Lanjutkan</button>
            </div>
        </div>
    </div>
    
    <!-- Custom Notification -->
    <div id="notification" class="fixed top-5 right-5 bg-green-500 text-white py-2 px-5 rounded-lg shadow-lg transform translate-x-[120%] transition-transform duration-300 ease-in-out z-[10001]">
        <p id="notification-message">Aksi berhasil!</p>
    </div>


    <!-- ===== HALAMAN LOGIN ===== -->
    <div id="login-page" class="min-h-screen flex items-center justify-center bg-gray-100 p-4">
        <div class="bg-white w-full max-w-md p-8 rounded-2xl shadow-xl border border-gray-200">
            <div class="text-center mb-8">
                <img src="https://placehold.co/100x100/b91c1c/ffffff?text=RI-80" alt="Logo HUT RI 80" class="mx-auto mb-4 rounded-full">
                <h1 class="text-3xl font-bold text-gray-900">Panel Keuangan</h1>
                <p class="text-gray-500">HUT Republik Indonesia ke-80</p>
            </div>
            <form id="login-form" class="space-y-4">
                <div>
                    <label for="email" class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                    <input type="email" id="email" class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-brand-red-500" placeholder="contoh@email.com" required>
                </div>
                <div>
                    <label for="password" class="block text-sm font-medium text-gray-700 mb-1">Password</label>
                    <input type="password" id="password" class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-brand-red-500" placeholder="••••••••" required>
                </div>
                <p id="error-message" class="text-red-600 text-sm text-center pt-2"></p>
                <button type="submit" class="w-full bg-brand-red-700 text-white font-bold py-3 px-4 rounded-lg hover:bg-brand-red-800 transition-all duration-300 shadow-sm">Login</button>
            </form>
            <div class="relative my-6">
              <div class="absolute inset-0 flex items-center"><span class="w-full border-t"></span></div>
              <div class="relative flex justify-center text-xs uppercase"><span class="bg-white px-2 text-gray-500">Atau</span></div>
            </div>
            <button id="visitor-login-btn" class="w-full bg-gray-100 text-gray-700 font-bold py-3 px-4 rounded-lg hover:bg-gray-200 transition-all duration-300">Masuk sebagai Visitor</button>
        </div>
    </div>

    <!-- ===== HALAMAN DASHBOARD MANAJEMEN ===== -->
    <div id="dashboard-page" class="hidden flex h-screen bg-gray-50">
        <!-- Sidebar -->
        <aside id="sidebar" class="w-64 bg-brand-red-800 text-white flex-col fixed inset-y-0 left-0 z-40 transform -translate-x-full transition-transform duration-300 ease-in-out md:relative md:translate-x-0 md:flex">
            <div class="h-20 flex items-center justify-center border-b border-brand-red-900/50">
                <h1 class="text-xl font-bold tracking-wider">KP.CEMPLANG RW 02</h1>
            </div>
            <nav class="flex-1 px-4 py-4 space-y-2">
                <a href="#" id="menu-dashboard" class="flex items-center gap-3 px-4 py-2.5 rounded-lg text-sm font-medium"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10v11h6v-7h6v7h6V10L12 3 3 10z"/></svg>Dashboard</a>
                <a href="#" id="menu-uang-masuk" class="flex items-center gap-3 px-4 py-2.5 rounded-lg text-sm font-medium"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v.01M12 6v-1m0-1H9.5a2.5 2.5 0 00-2.5 2.5V17.5a2.5 2.5 0 002.5 2.5h5A2.5 2.5 0 0017 17.5v-2.5a2.5 2.5 0 00-2.5-2.5H12"></path></svg>Uang Masuk</a>
                <a href="#" id="menu-uang-muka" class="flex items-center gap-3 px-4 py-2.5 rounded-lg text-sm font-medium"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v.01M12 6v-1m0-1H9.5a2.5 2.5 0 00-2.5 2.5V17.5a2.5 2.5 0 002.5 2.5h5A2.5 2.5 0 0017 17.5v-2.5a2.5 2.5 0 00-2.5-2.5H12" /></svg>Uang Muka</a>
                <a href="#" id="menu-uang-keluar" class="flex items-center gap-3 px-4 py-2.5 rounded-lg text-sm font-medium"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-2m-4-4l-4 4m0 0l4 4m-4-4h12" /></svg>Uang Keluar</a>
                <a href="#" id="menu-donatur" class="flex items-center gap-3 px-4 py-2.5 rounded-lg text-sm font-medium"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M21 11.25v8.25a2.25 2.25 0 01-2.25 2.25H5.25A2.25 2.25 0 013 19.5v-8.25a2.25 2.25 0 012.25-2.25h13.5A2.25 2.25 0 0121 11.25z" /><path stroke-linecap="round" stroke-linejoin="round" d="M12 15v-3.75m0 0a3.75 3.75 0 100-7.5 3.75 3.75 0 000 7.5z" /></svg>Daftar Donatur</a>
                <a href="#" id="menu-profile" class="flex items-center gap-3 px-4 py-2.5 rounded-lg text-sm font-medium"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 6a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0zM4.501 20.118a7.5 7.5 0 0114.998 0A17.933 17.933 0 0112 21.75c-2.676 0-5.216-.584-7.499-1.632z" /></svg>Profil Pengguna</a>
            </nav>
            <div class="px-4 py-4 mt-auto border-t border-brand-red-900/50">
                <button id="logout-button" class="w-full flex items-center gap-3 px-4 py-2.5 rounded-lg text-sm font-medium text-red-200 hover:bg-brand-red-700 hover:text-white"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.75 9V5.25A2.25 2.25 0 0013.5 3h-6a2.25 2.25 0 00-2.25 2.25v13.5A2.25 2.25 0 007.5 21h6a2.25 2.25 0 002.25-2.25V15m3 0l3-3m0 0l-3-3m3 3H9" /></svg>Logout</button>
            </div>
        </aside>
        
        <div id="sidebar-overlay" class="fixed inset-0 bg-black/60 z-30 hidden md:hidden"></div>

        <div class="flex-1 flex flex-col overflow-hidden">
            <header class="bg-white border-b border-gray-200">
                <div class="px-4 sm:px-6 lg:px-8">
                    <div class="flex items-center justify-between h-16">
                        <button id="mobile-menu-button" class="md:hidden text-gray-600 focus:outline-none">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
                        </button>
                        <h1 id="page-title" class="hidden md:block text-2xl font-bold text-gray-800">Dashboard</h1>
                        <div id="role-indicator" class="text-sm font-bold px-3 py-1 rounded-full"></div>
                    </div>
                </div>
            </header>
            <main class="flex-1 overflow-x-hidden overflow-y-auto bg-gray-50 p-4 sm:p-6 lg:p-8">
                <div id="content-dashboard" class="space-y-8">
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
                        <div class="bg-white border border-gray-200 p-6 rounded-xl shadow-sm"><div class="flex items-center gap-4"><div class="bg-green-100 p-3 rounded-full"><svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6v12m6-6H6" /></svg></div><div><h3 class="text-sm font-medium text-gray-500">Total Pemasukan</h3><p id="summary-pemasukan" class="text-2xl font-bold text-gray-900"></p></div></div></div>
                        <div class="bg-white border border-gray-200 p-6 rounded-xl shadow-sm"><div class="flex items-center gap-4"><div class="bg-red-100 p-3 rounded-full"><svg class="w-6 h-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M18 12H6" /></svg></div><div><h3 class="text-sm font-medium text-gray-500">Total Uang Keluar</h3><p id="summary-keluar" class="text-2xl font-bold text-gray-900"></p></div></div></div>
                        <div class="bg-white border border-gray-200 p-6 rounded-xl shadow-sm"><div class="flex items-center gap-4"><div class="bg-yellow-100 p-3 rounded-full"><svg class="w-6 h-6 text-yellow-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6h4.5m4.5 0a9 9 0 11-18 0 9 9 0 0118 0z" /></svg></div><div><h3 class="text-sm font-medium text-gray-500">Sisa Uang Muka</h3><p id="summary-sisa-muka" class="text-2xl font-bold text-gray-900"></p></div></div></div>
                        <div class="bg-white border border-gray-200 p-6 rounded-xl shadow-sm"><div class="flex items-center gap-4"><div class="bg-blue-100 p-3 rounded-full"><svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /><path stroke-linecap="round" stroke-linejoin="round" d="M12 8v4l3 3" /></svg></div><div><h3 class="text-sm font-medium text-gray-500">Saldo Akhir</h3><p id="summary-saldo" class="text-2xl font-bold text-gray-900"></p></div></div></div>
                    </div>
                    <div class="bg-white border border-gray-200 p-6 rounded-xl shadow-sm">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">Grafik Visualisasi Anggaran</h3>
                        <div class="h-96 relative">
                           <canvas id="financial-chart"></canvas>
                        </div>
                    </div>
                </div>
                
                <div id="content-uang-masuk" class="hidden space-y-6">
                    <div id="form-container-masuk" class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                        <h2 id="form-title-masuk" class="text-xl font-bold mb-4 text-gray-800">Tambah Data Uang Masuk</h2>
                        <form id="form-masuk" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="md:col-span-2"><label for="desc-masuk" class="block text-sm font-medium text-gray-700">Keterangan</label><input type="text" id="desc-masuk" class="mt-1 block w-full border-gray-300 rounded-lg shadow-sm" required></div>
                            <div><label for="amount-masuk" class="block text-sm font-medium text-gray-700">Jumlah Pemasukan (Rp)</label><input type="number" id="amount-masuk" class="mt-1 block w-full border-gray-300 rounded-lg shadow-sm" required></div>
                            <div class="md:col-span-2 flex justify-end space-x-3 pt-2">
                                <button type="button" id="cancel-edit-masuk" class="hidden bg-gray-600 text-white font-medium py-2 px-4 rounded-lg">Batal</button>
                                <button type="submit" id="submit-masuk" class="bg-brand-red-700 text-white font-medium py-2 px-4 rounded-lg">Tambah</button>
                            </div>
                        </form>
                    </div>
                    <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                        <div class="p-4"><input type="text" id="search-masuk" placeholder="Cari berdasarkan keterangan..." class="w-full md:w-1/2 px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-brand-red-500"></div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm">
                                <thead>
                                    <tr class="bg-gray-50">
                                        <th class="p-4 text-left font-semibold text-gray-600">No</th>
                                        <th class="p-4 text-left font-semibold text-gray-600">Keterangan</th>
                                        <th class="p-4 text-right font-semibold text-gray-600">Jumlah</th>
                                        <th class="p-4 text-left font-semibold text-gray-600">Tanggal</th>
                                        <th id="aksi-header-masuk" class="p-4 text-center font-semibold text-gray-600">Aksi</th>
                                    </tr>
                                </thead>
                                <tbody id="table-body-masuk" class="divide-y divide-gray-200"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div id="content-uang-muka" class="hidden space-y-6">
                    <div id="form-container-muka" class="bg-white p-6 rounded-xl shadow-sm border border-gray-200"><h2 id="form-title-muka" class="text-xl font-bold mb-4 text-gray-800">Tambah Data Uang Muka</h2><form id="form-muka" class="grid grid-cols-1 md:grid-cols-2 gap-4"><div class="md:col-span-2"><label for="desc-muka" class="block text-sm font-medium text-gray-700">Keterangan</label><input type="text" id="desc-muka" class="mt-1 block w-full border-gray-300 rounded-lg shadow-sm" required></div><div><label for="total-muka" class="block text-sm font-medium text-gray-700">Total Tagihan (Rp)</label><input type="number" id="total-muka" class="mt-1 block w-full border-gray-300 rounded-lg shadow-sm" required></div><div><label for="dp-muka" class="block text-sm font-medium text-gray-700">Uang Muka (Rp)</label><input type="number" id="dp-muka" class="mt-1 block w-full border-gray-300 rounded-lg shadow-sm" required></div><div class="md:col-span-2 flex justify-end space-x-3 pt-2"><button type="button" id="cancel-edit-muka" class="hidden bg-gray-600 text-white font-medium py-2 px-4 rounded-lg">Batal</button><button type="submit" id="submit-muka" class="bg-brand-red-700 text-white font-medium py-2 px-4 rounded-lg">Tambah</button></div></form></div>
                    <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden"><div class="p-4"><input type="text" id="search-muka" placeholder="Cari berdasarkan keterangan..." class="w-full md:w-1/2 px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-brand-red-500"></div><div class="overflow-x-auto"><table class="w-full text-sm"><thead><tr class="bg-gray-50"><th class="p-4 text-left font-semibold text-gray-600">No</th><th class="p-4 text-left font-semibold text-gray-600">Keterangan</th><th class="p-4 text-right font-semibold text-gray-600">Total Tagihan</th><th class="p-4 text-right font-semibold text-gray-600">Uang Muka</th><th class="p-4 text-right font-semibold text-gray-600">Sisa</th><th id="aksi-header-muka" class="p-4 text-center font-semibold text-gray-600">Aksi</th></tr></thead><tbody id="table-body-muka" class="divide-y divide-gray-200"></tbody></table></div></div>
                </div>

                <div id="content-uang-keluar" class="hidden space-y-6">
                    <div id="form-container-keluar" class="bg-white p-6 rounded-xl shadow-sm border border-gray-200"><h2 id="form-title-keluar" class="text-xl font-bold mb-4 text-gray-800">Tambah Data Uang Keluar</h2><form id="form-keluar" class="grid grid-cols-1 gap-4"><div class="md:col-span-2"><label for="desc-keluar" class="block text-sm font-medium text-gray-700">Keterangan Pengeluaran</label><input type="text" id="desc-keluar" class="mt-1 block w-full border-gray-300 rounded-lg shadow-sm" required></div><div class="md:col-span-2"><label for="total-keluar" class="block text-sm font-medium text-gray-700">Jumlah Pengeluaran (Rp)</label><input type="number" id="total-keluar" class="mt-1 block w-full border-gray-300 rounded-lg shadow-sm" required></div><div class="md:col-span-2 flex justify-end space-x-3 pt-2"><button type="button" id="cancel-edit-keluar" class="hidden bg-gray-600 text-white font-medium py-2 px-4 rounded-lg">Batal</button><button type="submit" id="submit-keluar" class="bg-brand-red-700 text-white font-medium py-2 px-4 rounded-lg">Tambah</button></div></form></div>
                    <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden"><div class="p-4"><input type="text" id="search-keluar" placeholder="Cari berdasarkan keterangan..." class="w-full md:w-1/2 px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-brand-red-500"></div><div class="overflow-x-auto"><table class="w-full text-sm"><thead><tr class="bg-gray-50"><th class="p-4 text-left font-semibold text-gray-600">No</th><th class="p-4 text-left font-semibold text-gray-600">Keterangan</th><th class="p-4 text-right font-semibold text-gray-600">Jumlah</th><th id="aksi-header-keluar" class="p-4 text-center font-semibold text-gray-600">Aksi</th></tr></thead><tbody id="table-body-keluar" class="divide-y divide-gray-200"></tbody></table></div></div>
                </div>

                <div id="content-donatur" class="hidden space-y-6">
                    <div id="form-container-donatur" class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                        <h2 id="form-title-donatur" class="text-xl font-bold mb-4 text-gray-800">Tambah Data Donatur</h2>
                        <form id="form-donatur" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="md:col-span-2"><label for="name-donatur" class="block text-sm font-medium text-gray-700">Nama Donatur</label><input type="text" id="name-donatur" class="mt-1 block w-full border-gray-300 rounded-lg shadow-sm" required></div>
                            <div><label for="amount-donatur" class="block text-sm font-medium text-gray-700">Jumlah Donasi (Rp)</label><input type="number" id="amount-donatur" class="mt-1 block w-full border-gray-300 rounded-lg shadow-sm" required></div>
                            <div class="md:col-span-2 flex justify-end space-x-3 pt-2">
                                <button type="button" id="cancel-edit-donatur" class="hidden bg-gray-600 text-white font-medium py-2 px-4 rounded-lg">Batal</button>
                                <button type="submit" id="submit-donatur" class="bg-brand-red-700 text-white font-medium py-2 px-4 rounded-lg">Tambah</button>
                            </div>
                        </form>
                    </div>
                    <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                        <div class="p-4">
                            <input type="text" id="search-donatur" placeholder="Cari berdasarkan nama donatur..." class="w-full md:w-1/2 px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-brand-red-500">
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm">
                                <thead>
                                    <tr class="bg-gray-50">
                                        <th class="p-4 text-left font-semibold text-gray-600">No</th>
                                        <th class="p-4 text-left font-semibold text-gray-600">Nama Donatur</th>
                                        <th class="p-4 text-right font-semibold text-gray-600">Jumlah Donasi</th>
                                        <th class="p-4 text-left font-semibold text-gray-600">Tanggal</th>
                                        <th id="aksi-header-donatur" class="p-4 text-center font-semibold text-gray-600">Aksi</th>
                                    </tr>
                                </thead>
                                <tbody id="table-body-donatur" class="divide-y divide-gray-200"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div id="content-profile" class="hidden">
                    <div class="bg-white p-8 rounded-xl shadow-sm border border-gray-200 max-w-2xl mx-auto">
                        <h2 class="text-2xl font-bold mb-6 text-gray-800">Profil Pengguna</h2>
                        <div class="space-y-4">
                            <div>
                                <p class="text-sm text-gray-500">Email</p>
                                <p id="profile-email" class="text-lg font-medium text-gray-900"></p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-500">Role</p>
                                <p id="profile-role" class="text-lg font-medium text-gray-900 capitalize"></p>
                            </div>
                        </div>
                        <hr class="my-8">
                        <h3 class="text-xl font-bold mb-4 text-gray-800">Ganti Password</h3>
                        <form id="change-password-form" class="space-y-4"><div class="mb-4"><label for="new-password" class="block text-sm font-medium text-gray-700">Password Baru</label><input type="password" id="new-password" class="mt-1 block w-full border-gray-300 rounded-lg shadow-sm" required minlength="6"></div><div class="mb-6"><label for="confirm-password" class="block text-sm font-medium text-gray-700">Konfirmasi Password Baru</label><input type="password" id="confirm-password" class="mt-1 block w-full border-gray-300 rounded-lg shadow-sm" required></div><p id="password-message" class="text-sm text-center mb-4"></p><div class="flex justify-end"><button type="submit" class="bg-brand-red-700 text-white font-bold py-2 px-4 rounded-lg hover:bg-brand-red-800">Simpan Password</button></div></form>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signOut, onAuthStateChanged, signInWithEmailAndPassword, updatePassword } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, addDoc, updateDoc, deleteDoc, doc, serverTimestamp, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBcClx0H_0RKig3fnA8GxQ4hIdiChTArzg",
            authDomain: "reportvoucherreseller.firebaseapp.com",
            projectId: "reportvoucherreseller",
            storageBucket: "reportvoucherreseller.appspot.com",
            messagingSenderId: "868058615913",
            appId: "1:868058615913:web:6f9083e03524d9299d52f8"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        const usersCol = collection(db, 'users');
        const uangMasukCol = collection(db, `events/${firebaseConfig.projectId}/uangMasuk`);
        const uangMukaCol = collection(db, `events/${firebaseConfig.projectId}/uangMuka`);
        const uangKeluarCol = collection(db, `events/${firebaseConfig.projectId}/uangKeluar`);
        const donaturCol = collection(db, `events/${firebaseConfig.projectId}/donations`);

        let currentUser = null, userRole = null, editingMasukId = null, editingMukaId = null, editingKeluarId = null, editingDonaturId = null;
        let unsubscribeMasuk = null, unsubscribeMuka = null, unsubscribeKeluar = null, unsubscribeDonatur = null;
        let allDataMasuk = [], allDataMuka = [], allDataKeluar = [], allDataDonatur = [];
        let searchTermMasuk = '', searchTermMuka = '', searchTermKeluar = '', searchTermDonatur = '';
        let financialChartInstance = null;
        
        const $ = (selector) => document.querySelector(selector);

        const loadingOverlay = $('#loading-overlay');
        const loginPage = $('#login-page');
        const dashboardPage = $('#dashboard-page');
        const loginForm = $('#login-form');
        const emailInput = $('#email');
        const passwordInput = $('#password');
        const errorMessage = $('#error-message');
        const visitorLoginBtn = $('#visitor-login-btn');
        const logoutButton = $('#logout-button');
        const pageTitle = $('#page-title');
        const roleIndicator = $('#role-indicator');
        
        const confirmationModal = $('#confirmation-modal');
        const modalConfirmBtn = $('#modal-confirm-btn');
        const modalCancelBtn = $('#modal-cancel-btn');
        const notification = $('#notification');
        const notificationMessage = $('#notification-message');

        const menus = { dashboard: $('#menu-dashboard'), masuk: $('#menu-uang-masuk'), muka: $('#menu-uang-muka'), keluar: $('#menu-uang-keluar'), donatur: $('#menu-donatur'), profile: $('#menu-profile') };
        const contents = { dashboard: $('#content-dashboard'), masuk: $('#content-uang-masuk'), muka: $('#content-uang-muka'), keluar: $('#content-uang-keluar'), donatur: $('#content-donatur'), profile: $('#content-profile') };
        
        const formContainerMasuk = $('#form-container-masuk');
        const formMasuk = $('#form-masuk');
        const descMasukInput = $('#desc-masuk');
        const amountMasukInput = $('#amount-masuk');
        const tableBodyMasuk = $('#table-body-masuk');
        const formTitleMasuk = $('#form-title-masuk');
        const submitMasukBtn = $('#submit-masuk');
        const cancelEditMasukBtn = $('#cancel-edit-masuk');
        const aksiHeaderMasuk = $('#aksi-header-masuk');
        
        const formContainerMuka = $('#form-container-muka');
        const formMuka = $('#form-muka');
        const descMukaInput = $('#desc-muka');
        const totalMukaInput = $('#total-muka');
        const dpMukaInput = $('#dp-muka');
        const tableBodyMuka = $('#table-body-muka');
        const formTitleMuka = $('#form-title-muka');
        const submitMukaBtn = $('#submit-muka');
        const cancelEditMukaBtn = $('#cancel-edit-muka');
        const aksiHeaderMuka = $('#aksi-header-muka');

        const formContainerKeluar = $('#form-container-keluar');
        const formKeluar = $('#form-keluar');
        const descKeluarInput = $('#desc-keluar');
        const totalKeluarInput = $('#total-keluar');
        const tableBodyKeluar = $('#table-body-keluar');
        const formTitleKeluar = $('#form-title-keluar');
        const submitKeluarBtn = $('#submit-keluar');
        const cancelEditKeluarBtn = $('#cancel-edit-keluar');
        const aksiHeaderKeluar = $('#aksi-header-keluar');

        const formContainerDonatur = $('#form-container-donatur');
        const formDonatur = $('#form-donatur');
        const nameDonaturInput = $('#name-donatur');
        const amountDonaturInput = $('#amount-donatur');
        const tableBodyDonatur = $('#table-body-donatur');
        const formTitleDonatur = $('#form-title-donatur');
        const submitDonaturBtn = $('#submit-donatur');
        const cancelEditDonaturBtn = $('#cancel-edit-donatur');
        const aksiHeaderDonatur = $('#aksi-header-donatur');

        const searchMasukInput = $('#search-masuk');
        const searchMukaInput = $('#search-muka');
        const searchKeluarInput = $('#search-keluar');
        const searchDonaturInput = $('#search-donatur');
        
        const mobileMenuButton = $('#mobile-menu-button');
        const sidebar = $('#sidebar');
        const sidebarOverlay = $('#sidebar-overlay');
        
        const profileEmail = $('#profile-email');
        const profileRole = $('#profile-role');
        const changePasswordForm = $('#change-password-form');
        const newPasswordInput = $('#new-password');
        const confirmPasswordInput = $('#confirm-password');
        const passwordMessage = $('#password-message');

        const formatCurrency = (amount) => new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(amount);
        const formatDate = (timestamp) => {
            if (!timestamp || !timestamp.seconds) return 'N/A';
            return new Date(timestamp.seconds * 1000).toLocaleDateString('id-ID', {
                day: '2-digit', month: 'long', year: 'numeric'
            });
        };
        const showLoading = (show) => loadingOverlay.classList.toggle('hidden', !show);
        
        const showNotification = (message, isSuccess = true) => {
            notificationMessage.textContent = message;
            notification.classList.toggle('bg-green-500', isSuccess);
            notification.classList.toggle('bg-red-500', !isSuccess);
            notification.classList.remove('translate-x-[120%]');
            setTimeout(() => {
                notification.classList.add('translate-x-[120%]');
            }, 3000);
        };

        const showConfirmationModal = (title, message, onConfirm) => {
            $('#modal-title').textContent = title;
            $('#modal-message').textContent = message;
            confirmationModal.classList.remove('hidden');
            confirmationModal.classList.add('flex');
            
            modalConfirmBtn.onclick = () => {
                onConfirm();
                hideConfirmationModal();
            };
        };

        const hideConfirmationModal = () => {
            confirmationModal.classList.add('hidden');
            confirmationModal.classList.remove('flex');
            modalConfirmBtn.onclick = null;
        };
        modalCancelBtn.addEventListener('click', hideConfirmationModal);

        const renderUI = () => {
            if (!userRole) return;
            renderDashboard();
            renderTableMasuk();
            renderTableMuka();
            renderTableKeluar();
            renderTableDonatur();
            renderDashboardChart();
        };

        const renderDashboard = () => {
            const totalPemasukanIuran = allDataMasuk.filter(t => t.status === 'active').reduce((sum, trx) => sum + trx.amount, 0);
            const totalDonasi = allDataDonatur.reduce((sum, donor) => sum + donor.amount, 0);

            const totalPengeluaranReguler = allDataKeluar.filter(t => t.status === 'active').reduce((sum, trx) => sum + trx.amount, 0);
            const totalUangMuka = allDataMuka.filter(t => t.status === 'active').reduce((sum, trx) => sum + trx.downPayment, 0);
            
            const totalSisaMuka = allDataMuka.filter(t => t.status === 'active').reduce((sum, trx) => sum + (trx.totalAmount - trx.downPayment), 0);

            const totalPemasukan = totalPemasukanIuran + totalDonasi;
            const totalPengeluaran = totalPengeluaranReguler + totalUangMuka;
            const saldoAkhir = totalPemasukan - totalPengeluaran;

            $('#summary-pemasukan').textContent = formatCurrency(totalPemasukan);
            $('#summary-keluar').textContent = formatCurrency(totalPengeluaran);
            $('#summary-sisa-muka').textContent = formatCurrency(totalSisaMuka);
            $('#summary-saldo').textContent = formatCurrency(saldoAkhir);
        };

        const renderDashboardChart = () => {
            const ctx = document.getElementById('financial-chart').getContext('2d');
            
            const monthlyData = {};
            const monthNames = ["Januari", "Februari", "Maret", "April", "Mei", "Juni", "Juli", "Agustus", "September", "Oktober", "November", "Desember"];

            const processData = (data, amountField, dateField, type) => {
                 data.forEach(item => {
                    if ((item.status && item.status !== 'active') || !item[dateField]?.seconds) return;
                    
                    const date = new Date(item[dateField].seconds * 1000);
                    const monthKey = `${monthNames[date.getMonth()]} ${date.getFullYear()}`;

                    if (!monthlyData[monthKey]) {
                        monthlyData[monthKey] = { income: 0, outcome: 0 };
                    }
                    monthlyData[monthKey][type] += item[amountField];
                });
            };

            processData(allDataMasuk, 'amount', 'createdAt', 'income');
            processData(allDataMuka, 'downPayment', 'createdAt', 'outcome'); // FIX: Uang Muka is an outcome
            processData(allDataDonatur, 'amount', 'date', 'income');
            processData(allDataKeluar, 'amount', 'createdAt', 'outcome');
            
            const sortedLabels = Object.keys(monthlyData).sort((a, b) => {
                const [monthA, yearA] = a.split(' ');
                const [monthB, yearB] = b.split(' ');
                return new Date(`${monthA} 1, ${yearA}`) - new Date(`${monthB} 1, ${yearB}`);
            });

            const incomeData = sortedLabels.map(label => monthlyData[label].income);
            const outcomeData = sortedLabels.map(label => monthlyData[label].outcome);

            if (financialChartInstance) {
                financialChartInstance.destroy();
            }

            financialChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: sortedLabels,
                    datasets: [
                        {
                            label: 'Pemasukan',
                            data: incomeData,
                            backgroundColor: 'rgba(34, 197, 94, 0.6)',
                            borderColor: 'rgba(34, 197, 94, 1)',
                            borderWidth: 1,
                            borderRadius: 5,
                        },
                        {
                            label: 'Pengeluaran',
                            data: outcomeData,
                            backgroundColor: 'rgba(239, 68, 68, 0.6)',
                            borderColor: 'rgba(239, 68, 68, 1)',
                            borderWidth: 1,
                            borderRadius: 5,
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return 'Rp ' + new Intl.NumberFormat('id-ID').format(value);
                                }
                            }
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed.y !== null) {
                                        label += formatCurrency(context.parsed.y);
                                    }
                                    return label;
                                }
                            }
                        }
                    }
                }
            });
        };

        const renderTableMasuk = () => {
            tableBodyMasuk.innerHTML = '';
            const filteredData = allDataMasuk.filter(trx => trx.description.toLowerCase().includes(searchTermMasuk.toLowerCase()));
            filteredData.sort((a, b) => (a.createdAt?.seconds || 0) - (b.createdAt?.seconds || 0)).forEach((trx, index) => {
                const rowClass = trx.status === 'pending_deletion' ? 'pending-deletion' : '';
                let aksiButtons = '';
                if (userRole === 'admin') {
                    aksiButtons = trx.status === 'pending_deletion'
                        ? `<button onclick="window.handleApproveDelete('masuk', '${trx.id}')" class="font-medium text-green-600 hover:text-green-800 mr-3">Setujui</button><button onclick="window.handleRejectDelete('masuk', '${trx.id}')" class="font-medium text-red-600 hover:text-red-800">Tolak</button>`
                        : `<button onclick="window.handleEdit('masuk', '${trx.id}')" class="font-medium text-blue-600 hover:text-blue-800 mr-3">Edit</button><button onclick="window.handleDelete('masuk', '${trx.id}')" class="font-medium text-red-600 hover:text-red-800">Hapus</button>`;
                } else if (userRole === 'editor') {
                    aksiButtons = trx.status !== 'pending_deletion'
                        ? `<button onclick="window.handleEdit('masuk', '${trx.id}')" class="font-medium text-blue-600 hover:text-blue-800 mr-3">Edit</button><button onclick="window.handleDelete('masuk', '${trx.id}')" class="font-medium text-red-600 hover:text-red-800">Hapus</button>`
                        : `<span class="text-gray-500">Menunggu</span>`;
                }
                const row = `<tr class="${rowClass} hover:bg-gray-50"><td class="p-4 text-gray-700">${index + 1}</td><td class="p-4 text-gray-900 font-medium">${trx.description}</td><td class="p-4 text-right font-semibold text-green-600">${formatCurrency(trx.amount)}</td><td class="p-4 text-gray-600">${formatDate(trx.createdAt)}</td>${userRole !== 'visitor' ? `<td class="p-4 text-center">${aksiButtons}</td>` : ''}</tr>`;
                tableBodyMasuk.innerHTML += row;
            });
        };

        const renderTableMuka = () => {
            tableBodyMuka.innerHTML = '';
            const filteredData = allDataMuka.filter(trx => trx.description.toLowerCase().includes(searchTermMuka.toLowerCase()));
            filteredData.sort((a, b) => (a.createdAt?.seconds || 0) - (b.createdAt?.seconds || 0)).forEach((trx, index) => {
                const sisa = trx.totalAmount - trx.downPayment;
                const rowClass = trx.status === 'pending_deletion' ? 'pending-deletion' : '';
                let aksiButtons = '';

                if (userRole === 'admin') {
                    aksiButtons = trx.status === 'pending_deletion'
                        ? `<button onclick="window.handleApproveDelete('muka', '${trx.id}')" class="font-medium text-green-600 hover:text-green-800 mr-3">Setujui</button><button onclick="window.handleRejectDelete('muka', '${trx.id}')" class="font-medium text-red-600 hover:text-red-800">Tolak</button>`
                        : `<button onclick="window.handleEdit('muka', '${trx.id}')" class="font-medium text-blue-600 hover:text-blue-800 mr-3">Edit</button><button onclick="window.handleDelete('muka', '${trx.id}')" class="font-medium text-red-600 hover:text-red-800">Hapus</button>`;
                } else if (userRole === 'editor') {
                    aksiButtons = trx.status !== 'pending_deletion'
                        ? `<button onclick="window.handleEdit('muka', '${trx.id}')" class="font-medium text-blue-600 hover:text-blue-800 mr-3">Edit</button><button onclick="window.handleDelete('muka', '${trx.id}')" class="font-medium text-red-600 hover:text-red-800">Hapus</button>`
                        : `<span class="text-gray-500">Menunggu</span>`;
                }

                const row = `<tr class="${rowClass} hover:bg-gray-50"><td class="p-4 text-gray-700">${index + 1}</td><td class="p-4 text-gray-900 font-medium">${trx.description}</td><td class="p-4 text-right text-gray-600">${formatCurrency(trx.totalAmount)}</td><td class="p-4 text-right text-green-600 font-semibold">${formatCurrency(trx.downPayment)}</td><td class="p-4 text-right font-medium ${sisa > 0 ? 'text-orange-600' : 'text-green-600'}">${formatCurrency(sisa)}</td>${userRole !== 'visitor' ? `<td class="p-4 text-center">${aksiButtons}</td>` : ''}</tr>`;
                tableBodyMuka.innerHTML += row;
            });
        };

        const renderTableKeluar = () => {
            tableBodyKeluar.innerHTML = '';
            const filteredData = allDataKeluar.filter(trx => trx.description.toLowerCase().includes(searchTermKeluar.toLowerCase()));
            filteredData.sort((a, b) => (a.createdAt?.seconds || 0) - (b.createdAt?.seconds || 0)).forEach((trx, index) => {
                const rowClass = trx.status === 'pending_deletion' ? 'pending-deletion' : '';
                let aksiButtons = '';

                if (userRole === 'admin') {
                    aksiButtons = trx.status === 'pending_deletion'
                        ? `<button onclick="window.handleApproveDelete('keluar', '${trx.id}')" class="font-medium text-green-600 hover:text-green-800 mr-3">Setujui</button><button onclick="window.handleRejectDelete('keluar', '${trx.id}')" class="font-medium text-red-600 hover:text-red-800">Tolak</button>`
                        : `<button onclick="window.handleEdit('keluar', '${trx.id}')" class="font-medium text-blue-600 hover:text-blue-800 mr-3">Edit</button><button onclick="window.handleDelete('keluar', '${trx.id}')" class="font-medium text-red-600 hover:text-red-800">Hapus</button>`;
                } else if (userRole === 'editor') {
                    aksiButtons = trx.status !== 'pending_deletion'
                        ? `<button onclick="window.handleEdit('keluar', '${trx.id}')" class="font-medium text-blue-600 hover:text-blue-800 mr-3">Edit</button><button onclick="window.handleDelete('keluar', '${trx.id}')" class="font-medium text-red-600 hover:text-red-800">Hapus</button>`
                        : `<span class="text-gray-500">Menunggu</span>`;
                }
                
                const row = `<tr class="${rowClass} hover:bg-gray-50"><td class="p-4 text-gray-700">${index + 1}</td><td class="p-4 text-gray-900 font-medium">${trx.description}</td><td class="p-4 text-right font-semibold text-red-600">${formatCurrency(trx.amount)}</td>${userRole !== 'visitor' ? `<td class="p-4 text-center">${aksiButtons}</td>` : ''}</tr>`;
                tableBodyKeluar.innerHTML += row;
            });
        };

        const renderTableDonatur = () => {
            tableBodyDonatur.innerHTML = '';
            const filteredData = allDataDonatur.filter(donor => donor.name.toLowerCase().includes(searchTermDonatur.toLowerCase()));
            filteredData.sort((a, b) => (a.date?.seconds || 0) - (b.date?.seconds || 0)).forEach((donor, index) => {
                let aksiButtons = '';
                if (userRole === 'admin' || userRole === 'editor') {
                    aksiButtons = `<button onclick="window.handleEdit('donatur', '${donor.id}')" class="font-medium text-blue-600 hover:text-blue-800 mr-3">Edit</button>`;
                }
                if (userRole === 'admin') {
                    aksiButtons += `<button onclick="window.handleDelete('donatur', '${donor.id}')" class="font-medium text-red-600 hover:text-red-800">Hapus</button>`;
                }

                const row = `<tr class="hover:bg-gray-50">
                    <td class="p-4 text-gray-700">${index + 1}</td>
                    <td class="p-4 text-gray-900 font-medium">${donor.name}</td>
                    <td class="p-4 text-right text-green-600 font-semibold">${formatCurrency(donor.amount)}</td>
                    <td class="p-4 text-gray-600">${formatDate(donor.date)}</td>
                    ${userRole !== 'visitor' ? `<td class="p-4 text-center">${aksiButtons}</td>` : ''}
                </tr>`;
                tableBodyDonatur.innerHTML += row;
            });
        };

        const setupUIForRole = () => {
            const isEditorOrAdmin = userRole === 'admin' || userRole === 'editor';
            formContainerMasuk.style.display = isEditorOrAdmin ? 'block' : 'none';
            formContainerMuka.style.display = isEditorOrAdmin ? 'block' : 'none';
            formContainerKeluar.style.display = isEditorOrAdmin ? 'block' : 'none';
            formContainerDonatur.style.display = isEditorOrAdmin ? 'block' : 'none';
            aksiHeaderMasuk.style.display = userRole !== 'visitor' ? 'table-cell' : 'none';
            aksiHeaderMuka.style.display = userRole !== 'visitor' ? 'table-cell' : 'none';
            aksiHeaderKeluar.style.display = userRole !== 'visitor' ? 'table-cell' : 'none';
            aksiHeaderDonatur.style.display = userRole !== 'visitor' ? 'table-cell' : 'none';

            const roles = { admin: 'Admin', editor: 'Editor', visitor: 'Visitor' };
            const colors = { admin: 'bg-red-100 text-red-700', editor: 'bg-blue-100 text-blue-700', visitor: 'bg-gray-200 text-gray-700' };
            roleIndicator.textContent = roles[userRole] || 'Unknown';
            roleIndicator.className = `text-sm font-bold px-3 py-1 rounded-full ${colors[userRole]}`;
        };

        const setupAndShowDashboard = () => {
            loginPage.classList.add('hidden');
            dashboardPage.classList.remove('hidden');
            setupUIForRole();
            switchPage('dashboard');
            renderUI();
        };

        const switchPage = (pageKey) => {
            const pageTitles = { dashboard: 'Dashboard', masuk: 'Manajemen Uang Masuk', muka: 'Manajemen Uang Muka', keluar: 'Manajemen Uang Keluar', donatur: 'Daftar Donatur', profile: 'Profil Pengguna' };
            pageTitle.textContent = pageTitles[pageKey];
            Object.keys(contents).forEach(key => {
                contents[key].classList.toggle('hidden', key !== pageKey);
                if (menus[key]) {
                    menus[key].classList.remove('bg-brand-red-900', 'text-white', 'text-red-200', 'hover:bg-brand-red-700', 'hover:text-white');
                    if (key === pageKey) {
                        menus[key].classList.add('bg-brand-red-900', 'text-white');
                    } else {
                        menus[key].classList.add('text-red-200', 'hover:bg-brand-red-700', 'hover:text-white');
                    }
                }
            });
            if (pageKey === 'profile' && currentUser) {
                profileEmail.textContent = currentUser.email;
                profileRole.textContent = userRole;
            }
            if (window.innerWidth < 768) {
                sidebar.classList.add('-translate-x-full');
                sidebarOverlay.classList.add('hidden');
            }
        };
        
        const toggleSidebar = () => {
            sidebar.classList.toggle('-translate-x-full');
            sidebarOverlay.classList.toggle('hidden');
        };

        const initializeDataListeners = () => {
            if (unsubscribeMasuk) unsubscribeMasuk();
            unsubscribeMasuk = onSnapshot(uangMasukCol, (snapshot) => {
                allDataMasuk = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                if(userRole) renderUI();
            });

            if (unsubscribeMuka) unsubscribeMuka();
            unsubscribeMuka = onSnapshot(uangMukaCol, (snapshot) => {
                allDataMuka = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                if(userRole) renderUI();
            });

            if (unsubscribeKeluar) unsubscribeKeluar();
            unsubscribeKeluar = onSnapshot(uangKeluarCol, (snapshot) => {
                allDataKeluar = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                if(userRole) renderUI();
            });

            if (unsubscribeDonatur) unsubscribeDonatur();
            unsubscribeDonatur = onSnapshot(donaturCol, (snapshot) => {
                allDataDonatur = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                if(userRole) renderUI();
            });
        };

        onAuthStateChanged(auth, async (user) => {
            showLoading(true);
            currentUser = user;
            if (user) {
                try {
                    const userDocRef = doc(usersCol, user.uid);
                    const userDocSnap = await getDoc(userDocRef);
                    userRole = (userDocSnap.exists() && userDocSnap.data().role) ? userDocSnap.data().role : 'visitor';
                    initializeDataListeners();
                    setupAndShowDashboard();
                } catch (error) {
                    console.error("Gagal mengambil peran:", error);
                    errorMessage.textContent = 'Gagal memuat data pengguna.';
                    await signOut(auth);
                }
            } else {
                userRole = null;
                if (unsubscribeMasuk) unsubscribeMasuk();
                if (unsubscribeMuka) unsubscribeMuka();
                if (unsubscribeKeluar) unsubscribeKeluar();
                if (unsubscribeDonatur) unsubscribeDonatur();
                loginPage.classList.remove('hidden');
                dashboardPage.classList.add('hidden');
                loginForm.reset();
            }
            showLoading(false);
        });

        const handleLogin = async (e) => {
            e.preventDefault();
            errorMessage.textContent = '';
            showLoading(true);
            try {
                await signInWithEmailAndPassword(auth, emailInput.value, passwordInput.value);
            } catch (error) {
                errorMessage.textContent = 'Email atau password salah.';
            } finally {
                showLoading(false);
            }
        };

        const handleVisitorLogin = () => {
            userRole = 'visitor';
            initializeDataListeners();
            setupAndShowDashboard();
        };

        const handleLogout = async () => {
            showConfirmationModal('Konfirmasi Logout', 'Apakah Anda yakin ingin keluar dari sesi ini?', async () => {
                if (currentUser) await signOut(auth);
                else {
                    userRole = null;
                    loginPage.classList.remove('hidden');
                    dashboardPage.classList.add('hidden');
                }
            });
        };

        const handleFormSubmit = async (type, e) => {
            e.preventDefault();
            if (userRole !== 'admin' && userRole !== 'editor') return;
            showLoading(true);
            try {
                if (type === 'masuk') {
                    const data = { description: descMasukInput.value, amount: parseFloat(amountMasukInput.value), status: 'active', createdAt: serverTimestamp() };
                    if (editingMasukId) {
                        await updateDoc(doc(uangMasukCol, editingMasukId), data);
                        showNotification('Data uang masuk berhasil diperbarui.');
                    } else {
                        await addDoc(uangMasukCol, data);
                        showNotification('Data uang masuk berhasil ditambahkan.');
                    }
                    resetForm('masuk');
                } else if (type === 'muka') {
                    const data = { description: descMukaInput.value, totalAmount: parseFloat(totalMukaInput.value), downPayment: parseFloat(dpMukaInput.value), status: 'active', createdAt: serverTimestamp() };
                    if (editingMukaId) {
                        await updateDoc(doc(uangMukaCol, editingMukaId), data);
                        showNotification('Data uang muka berhasil diperbarui.');
                    } else {
                        await addDoc(uangMukaCol, data);
                        showNotification('Data uang muka berhasil ditambahkan.');
                    }
                    resetForm('muka');
                } else if (type === 'keluar') {
                    const data = { description: descKeluarInput.value, amount: parseFloat(totalKeluarInput.value), status: 'active', createdAt: serverTimestamp() };
                    if (editingKeluarId) {
                        await updateDoc(doc(uangKeluarCol, editingKeluarId), data);
                        showNotification('Data uang keluar berhasil diperbarui.');
                    } else {
                        await addDoc(uangKeluarCol, data);
                        showNotification('Data uang keluar berhasil ditambahkan.');
                    }
                    resetForm('keluar');
                } else if (type === 'donatur') {
                    const data = { name: nameDonaturInput.value, amount: parseFloat(amountDonaturInput.value), date: serverTimestamp() };
                     if (editingDonaturId) {
                        await updateDoc(doc(donaturCol, editingDonaturId), data);
                        showNotification('Data donatur berhasil diperbarui.');
                    } else {
                        await addDoc(donaturCol, data);
                        showNotification('Data donatur berhasil ditambahkan.');
                    }
                    resetForm('donatur');
                }
            } catch (error) {
                console.error("Error submitting form:", error);
                showNotification('Gagal menyimpan data.', false);
            } finally {
                showLoading(false);
            }
        };
        
        const resetForm = (type) => {
            if (type === 'masuk') {
                editingMasukId = null;
                formMasuk.reset();
                formTitleMasuk.textContent = 'Tambah Data Uang Masuk';
                submitMasukBtn.textContent = 'Tambah';
                cancelEditMasukBtn.classList.add('hidden');
            } else if (type === 'muka') {
                editingMukaId = null;
                formMuka.reset();
                formTitleMuka.textContent = 'Tambah Data Uang Muka';
                submitMukaBtn.textContent = 'Tambah';
                cancelEditMukaBtn.classList.add('hidden');
            } else if (type === 'keluar') {
                editingKeluarId = null;
                formKeluar.reset();
                formTitleKeluar.textContent = 'Tambah Data Uang Keluar';
                submitKeluarBtn.textContent = 'Tambah';
                cancelEditKeluarBtn.classList.add('hidden');
            } else if (type === 'donatur') {
                editingDonaturId = null;
                formDonatur.reset();
                formTitleDonatur.textContent = 'Tambah Data Donatur';
                submitDonaturBtn.textContent = 'Tambah';
                cancelEditDonaturBtn.classList.add('hidden');
            }
        };

        window.handleEdit = async (type, id) => {
            showLoading(true);
            const colRef = type === 'masuk' ? uangMasukCol : type === 'muka' ? uangMukaCol : type === 'keluar' ? uangKeluarCol : donaturCol;
            const docSnap = await getDoc(doc(colRef, id));
            if (docSnap.exists()) {
                const data = docSnap.data();
                if (type === 'masuk') {
                    editingMasukId = id;
                    descMasukInput.value = data.description;
                    amountMasukInput.value = data.amount;
                    formTitleMasuk.textContent = 'Edit Data Uang Masuk';
                    submitMasukBtn.textContent = 'Update';
                    cancelEditMasukBtn.classList.remove('hidden');
                    descMasukInput.focus();
                } else if (type === 'muka') {
                    editingMukaId = id;
                    descMukaInput.value = data.description;
                    totalMukaInput.value = data.totalAmount;
                    dpMukaInput.value = data.downPayment;
                    formTitleMuka.textContent = 'Edit Data Uang Muka';
                    submitMukaBtn.textContent = 'Update';
                    cancelEditMukaBtn.classList.remove('hidden');
                    descMukaInput.focus();
                } else if (type === 'keluar') {
                    editingKeluarId = id;
                    descKeluarInput.value = data.description;
                    totalKeluarInput.value = data.amount;
                    formTitleKeluar.textContent = 'Edit Data Uang Keluar';
                    submitKeluarBtn.textContent = 'Update';
                    cancelEditKeluarBtn.classList.remove('hidden');
                    descKeluarInput.focus();
                } else if (type === 'donatur') {
                    editingDonaturId = id;
                    nameDonaturInput.value = data.name;
                    amountDonaturInput.value = data.amount;
                    formTitleDonatur.textContent = 'Edit Data Donatur';
                    submitDonaturBtn.textContent = 'Update';
                    cancelEditDonaturBtn.classList.remove('hidden');
                    nameDonaturInput.focus();
                }
            }
            showLoading(false);
        };

        window.handleDelete = async (type, id) => {
            const colRef = type === 'masuk' ? uangMasukCol : type === 'muka' ? uangMukaCol : type === 'keluar' ? uangKeluarCol : donaturCol;
            
            if (type === 'donatur' || type === 'masuk') {
                if (userRole === 'admin') {
                    showConfirmationModal(`Hapus ${type === 'donatur' ? 'Donatur' : 'Uang Masuk'}`, `Yakin ingin menghapus data ini secara permanen?`, async () => {
                        await deleteDoc(doc(colRef, id));
                        showNotification(`Data ${type === 'donatur' ? 'donatur' : 'uang masuk'} berhasil dihapus.`);
                    });
                }
                return;
            }

            if (userRole === 'admin') {
                showConfirmationModal('Hapus Permanen', 'Yakin ingin menghapus data ini secara permanen?', async () => {
                    await deleteDoc(doc(colRef, id));
                    showNotification('Data berhasil dihapus.');
                });
            } else if (userRole === 'editor') {
                showConfirmationModal('Ajukan Hapus', 'Ajukan permintaan hapus data ini kepada admin?', async () => {
                    await updateDoc(doc(colRef, id), { status: 'pending_deletion' });
                    showNotification('Permintaan hapus telah diajukan.');
                });
            }
        };
        
        window.handleApproveDelete = async (type, id) => {
            const colRef = type === 'masuk' ? uangMasukCol : type === 'muka' ? uangMukaCol : uangKeluarCol;
            await deleteDoc(doc(colRef, id));
            showNotification('Permintaan hapus disetujui. Data dihapus.');
        };
        
        window.handleRejectDelete = async (type, id) => {
            const colRef = type === 'masuk' ? uangMasukCol : type === 'muka' ? uangMukaCol : uangKeluarCol;
            await updateDoc(doc(colRef, id), { status: 'active' });
            showNotification('Permintaan hapus ditolak.');
        };
        
        changePasswordForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            passwordMessage.textContent = '';
            if (newPasswordInput.value !== confirmPasswordInput.value) {
                passwordMessage.textContent = 'Password baru dan konfirmasi tidak cocok.'; return;
            }
            try {
                await updatePassword(currentUser, newPasswordInput.value);
                showNotification('Password berhasil diperbarui!');
                changePasswordForm.reset();
            } catch (error) {
                showNotification('Gagal memperbarui password.', false);
            }
        });

        loginForm.addEventListener('submit', handleLogin);
        visitorLoginBtn.addEventListener('click', handleVisitorLogin);
        logoutButton.addEventListener('click', handleLogout);
        mobileMenuButton.addEventListener('click', toggleSidebar);
        sidebarOverlay.addEventListener('click', toggleSidebar);

        Object.keys(menus).forEach(key => {
            menus[key].addEventListener('click', (e) => { e.preventDefault(); switchPage(key); });
        });

        formMasuk.addEventListener('submit', (e) => handleFormSubmit('masuk', e));
        cancelEditMasukBtn.addEventListener('click', () => resetForm('masuk'));
        formMuka.addEventListener('submit', (e) => handleFormSubmit('muka', e));
        cancelEditMukaBtn.addEventListener('click', () => resetForm('muka'));
        formKeluar.addEventListener('submit', (e) => handleFormSubmit('keluar', e));
        cancelEditKeluarBtn.addEventListener('click', () => resetForm('keluar'));
        formDonatur.addEventListener('submit', (e) => handleFormSubmit('donatur', e));
        cancelEditDonaturBtn.addEventListener('click', () => resetForm('donatur'));

        searchMasukInput.addEventListener('input', (e) => { searchTermMasuk = e.target.value; renderTableMasuk(); });
        searchMukaInput.addEventListener('input', (e) => { searchTermMuka = e.target.value; renderTableMuka(); });
        searchKeluarInput.addEventListener('input', (e) => { searchTermKeluar = e.target.value; renderTableKeluar(); });
        searchDonaturInput.addEventListener('input', (e) => { searchTermDonatur = e.target.value; renderTableDonatur(); });
    </script>
</body>
</html>
